{"version":3,"file":"react-windowed-observable.esm.js","sources":["../src/context.tsx"],"sourcesContent":["import React, {\n  useContext,\n  useEffect,\n  useState,\n  createContext,\n  FC,\n  useMemo,\n} from 'react';\nimport {\n  CreateReactObservableOptions,\n  ObservableContextValue,\n  ObservableData,\n  ObservableProviderProps,\n  ReactObservable,\n  UseObservableReturn,\n} from './types';\n\nimport { Observable, Observer } from 'windowed-observable';\n\nconst ObservableProviderDisplayName = 'ObservableProvider';\n\nexport const UseObservableError = `useObservable must be used within an ${ObservableProviderDisplayName}`;\n\nexport function createReactObservable<T = any>(\n  namespace: string,\n  options?: CreateReactObservableOptions<T>\n): ReactObservable<T> {\n  const observable = new Observable<T>(namespace);\n\n  const ObservableContext = createContext<\n    ObservableContextValue<T> | undefined\n  >(undefined);\n\n  const ObservableProvider: FC<ObservableProviderProps<T>> = ({\n    children,\n    onChange,\n  }) => {\n    // istanbul ignore next\n    const [data, setData] = useState<ObservableData<T>>({\n      data: options?.initialData,\n      events: [],\n      lastEvent: undefined,\n    });\n\n    useEffect(() => {\n      const observer: Observer<T> = (newData, { events, lastEvent }) => {\n        setData({ data: newData, events, lastEvent });\n      };\n\n      observable.subscribe(observer);\n\n      return () => {\n        observable.unsubscribe(observer);\n      };\n    }, []);\n\n    useEffect(() => {\n      if (!onChange) {\n        return;\n      }\n\n      observable.subscribe(onChange);\n\n      return () => {\n        observable.unsubscribe(onChange);\n      };\n    }, [onChange]);\n\n    const value = useMemo(\n      () => ({\n        ...data,\n        publish: observable.publish,\n      }),\n      [data]\n    );\n\n    return (\n      <ObservableContext.Provider value={value}>\n        {children}\n      </ObservableContext.Provider>\n    );\n  };\n\n  ObservableProvider.displayName = ObservableProviderDisplayName;\n\n  function useObservable(): UseObservableReturn<T> {\n    const ctx = useContext(ObservableContext);\n    if (ctx === undefined) {\n      throw new Error(UseObservableError);\n    }\n\n    const { publish, ...context } = ctx;\n\n    return [context, publish];\n  }\n\n  return {\n    observable,\n    useObservable,\n    ObservableProvider,\n  };\n}\n"],"names":["ObservableProviderDisplayName","UseObservableError","createReactObservable","namespace","options","observable","Observable","ObservableContext","createContext","undefined","ObservableProvider","children","onChange","useState","data","initialData","events","lastEvent","setData","useEffect","observer","newData","subscribe","unsubscribe","value","useMemo","publish","React","Provider","displayName","useObservable","ctx","useContext","Error","context"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmBA,IAAMA,6BAA6B,GAAG,oBAAtC;AAEO,IAAMC,kBAAkB,6CAA2CD,6BAAnE;SAESE,sBACdC,WACAC;AAEA,MAAMC,UAAU,GAAG,IAAIC,UAAJ,CAAkBH,SAAlB,CAAnB;AAEA,MAAMI,iBAAiB,GAAGC,aAAa,CAErCC,SAFqC,CAAvC;;AAIA,MAAMC,kBAAkB,GAAmC,SAArDA,kBAAqD;QACzDC,gBAAAA;QACAC,gBAAAA;;AAEA;oBACwBC,QAAQ,CAAoB;AAClDC,MAAAA,IAAI,EAAEV,OAAF,oBAAEA,OAAO,CAAEW,WADmC;AAElDC,MAAAA,MAAM,EAAE,EAF0C;AAGlDC,MAAAA,SAAS,EAAER;AAHuC,KAApB;QAAzBK;QAAMI;;AAMbC,IAAAA,SAAS,CAAC;AACR,UAAMC,QAAQ,GAAgB,SAAxBA,QAAwB,CAACC,OAAD;YAAYL,eAAAA;YAAQC,kBAAAA;AAChDC,QAAAA,OAAO,CAAC;AAAEJ,UAAAA,IAAI,EAAEO,OAAR;AAAiBL,UAAAA,MAAM,EAANA,MAAjB;AAAyBC,UAAAA,SAAS,EAATA;AAAzB,SAAD,CAAP;AACD,OAFD;;AAIAZ,MAAAA,UAAU,CAACiB,SAAX,CAAqBF,QAArB;AAEA,aAAO;AACLf,QAAAA,UAAU,CAACkB,WAAX,CAAuBH,QAAvB;AACD,OAFD;AAGD,KAVQ,EAUN,EAVM,CAAT;AAYAD,IAAAA,SAAS,CAAC;AACR,UAAI,CAACP,QAAL,EAAe;AACb;AACD;;AAEDP,MAAAA,UAAU,CAACiB,SAAX,CAAqBV,QAArB;AAEA,aAAO;AACLP,QAAAA,UAAU,CAACkB,WAAX,CAAuBX,QAAvB;AACD,OAFD;AAGD,KAVQ,EAUN,CAACA,QAAD,CAVM,CAAT;AAYA,QAAMY,KAAK,GAAGC,OAAO,CACnB;AAAA,0BACKX,IADL;AAEEY,QAAAA,OAAO,EAAErB,UAAU,CAACqB;AAFtB;AAAA,KADmB,EAKnB,CAACZ,IAAD,CALmB,CAArB;AAQA,WACEa,mBAAA,CAACpB,iBAAiB,CAACqB,QAAnB;AAA4BJ,MAAAA,KAAK,EAAEA;KAAnC,EACGb,QADH,CADF;AAKD,GAhDD;;AAkDAD,EAAAA,kBAAkB,CAACmB,WAAnB,GAAiC7B,6BAAjC;;AAEA,WAAS8B,aAAT;AACE,QAAMC,GAAG,GAAGC,UAAU,CAACzB,iBAAD,CAAtB;;AACA,QAAIwB,GAAG,KAAKtB,SAAZ,EAAuB;AACrB,YAAM,IAAIwB,KAAJ,CAAUhC,kBAAV,CAAN;AACD;;QAEOyB,UAAwBK,IAAxBL;QAAYQ,wCAAYH;;AAEhC,WAAO,CAACG,OAAD,EAAUR,OAAV,CAAP;AACD;;AAED,SAAO;AACLrB,IAAAA,UAAU,EAAVA,UADK;AAELyB,IAAAA,aAAa,EAAbA,aAFK;AAGLpB,IAAAA,kBAAkB,EAAlBA;AAHK,GAAP;AAKD;;;;"}